<div xmlns:th="http://www.thymeleaf.org" class="main-div">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
    }

    .inner-div {
        flex:1;
    }

    .custom-dropdown {
      width: 200px;
    }

    #map {
        height: 100%;
    }
  </style>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <div class="container-fluid inner-div">
    <div class="row" style="margin: 0">
      <div class="col-4" style="padding: 0">
        <div id="additional-info"></div>
        <div class="row">
          <div class="col" id="starter">
            <h4>Additional Information</h4>
            <hr />
            <p id="info-content">
              Please select a location to display additional information.
            </p>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <form method="GET" action="/node/filteredByCategory">
              <label for="dropdown">Choose a category:</label>
              <select
                class="form-control form-control-sm custom-dropdown"
                name="category"
                id="dropdown"
              >
                <option th:each="category : ${categories}">
                  <th:block
                    th:value="${category}"
                    th:text="${category}"
                  ></th:block>
                </option>
              </select>
              <input type="submit" />
            </form>
          </div>

          <div
            th:if="${#authorization.expression('hasRole(''ROLE_ADMIN'')')}"
          >
            <div>
              <a
                href="/node/add-form"
                class="btn btn-block btn-dark add-product-btn"
              >
                Add new node
              </a>
            </div>
          </div>
        </div>
        <hr>
        <div id="controls"></div>
        <hr>
      </div>

      <div class="col-8" style="padding: 0; height: 850px;">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    let nodes = [(${nodes})];
    let map = L.map("map")
        .setView([41.6086, 21.7453], 9); // Skopje
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ''
    }).addTo(map);

    let markers = [];

    nodes.forEach(function (node) {
        let marker = L.marker([node.latitude, node.longitude])

        marker.on('click', function (e) {
            displayInfo(node);
            changeColorAndFocus(marker, markers);
        });

        markers.push(marker);
    });

    let markerGroup = L.featureGroup(markers).addTo(map);

    map.fitBounds(markerGroup.getBounds());

    function editNode(nodeId) {
        window.location.href = '/node/edit-form/' + nodeId;
    }

    // Getting location
    function getLocation(nodeLatitude, nodeLongitude) {
        // Get the location from the user
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                userLatitude = position.coords.latitude;
                userLongitude = position.coords.longitude;

                console.log(userLatitude, userLongitude); // For kind of debugging purposes

                sendLocationToServer(userLatitude, userLongitude, nodeLatitude, nodeLongitude);
            }, function () {
                alert("Geolocation access is blocked. Please update your browser settings to allow access.")
            });
        } else {
            alert("Geolocation is not supported by this browser.")
        }
    }

    let userLatitude;
    let userLongitude;
    let isAdmin = [(${isAdmin})]
    let isLoggedIn = [(${isLogin})]

    function sendLocationToServer(userLatitude, userLongitude, nodeLatitude, nodeLongitude) {
        console.log("Before fetch");
        fetch('/map/findRoute', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded',},
            body: `startLat=${userLatitude}&startLon=${userLongitude}&endLat=${nodeLatitude}&endLon=${nodeLongitude}`,
        }).then(response => {
            console.log("Received response with status: " + response.status); // For kind of debugging purposes

            if (response.status === 200) {
                console.log("Location sent successfully!");
                window.location.href = '/map';
            } else {
                alert("Error getting location");
            }
        }).catch(error => {
            console.error("Error sending location:", error);
        });
    }

    function rateNode(ratingValue, nodeId) {
        console.log("User rated:", ratingValue);
        window.location.href = '/node/updateRating/' + nodeId + '?userRating=' + ratingValue;
    }

    const displayInfo = (node) => {
        $("#additional-info").empty();  // Clear previous node data
        $("#starter").remove();
        let mainDiv = $("#additional-info")
        let controls = $("#controls");
        controls.empty();

        let res = $("<div>").addClass("container");
        let paragraph = $("<h3>").text(`${node.name}`);


        let locations = $("<p>").append(`üìç ${node.latitude}, ${node.longitude}`);


        let resetMapButton = $("<button>").text("Reset Map")
            .on("click", resetMap);

        let navigateButton = $("<button>").text("Navigate")
            .on("click", () => getLocation(node.latitude, node.longitude));
        let ratingIntroText = $("<p>").text("Current rating:")
            .css({ paddingTop: "10px", marginBottom: "0px" });

        let rating = $("<p>").text(node.rating.toFixed(2));
        let starContainer = $("<div>");

        if (node.wikipediaData) {
            paragraph.append(`<hr>${node.wikipediaData}`);
        }

        for (let i = 1; i <= 5; i++) {
            let star = document.createElement("button");
            star.innerHTML = "&#9733;";
            //star.setAttribute("onclick", `rateNode(${i}, ${node.id})`);
            if (isLoggedIn === true) {
                star.setAttribute("onclick", `rateNode(${i}, ${node.id})`);
            } else {
                star.style.pointerEvents = "none"; // Disable pointer events for unauthenticated users
                star.setAttribute("onclick", "showLoginMessage()");
            }
            starContainer.append(star);
        }

        res.append(paragraph, locations);
        controls.append(resetMapButton, navigateButton, ratingIntroText, rating, starContainer);

        if (!isLoggedIn) {
            const loginMessage = $("<p>").text("You must be logged in to leave a rating.");
            res.append(loginMessage);
        }

        if (isAdmin) {
            const editButton = $("<button>").text("Edit").on("click", () => editNode(node.id));
            res.append(editButton);
        }

        mainDiv.append(res);
    }

    function showLoginMessage() {
        alert("You must be logged in to leave a rating.");
    }

    const changeColorAndFocus = (marker, markers) => {
        markers.forEach((m) => {
            m.setIcon(new L.Icon.Default());
        });

        marker.setIcon(new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            tooltipAnchor: [16, -28],
            shadowSize: [41, 41]
        }))

        map.setView(marker.getLatLng(), 16);
    }


    const resetMap = () => {
        map.setView([41.6086, 21.7453], 9);

    }
  </script>
</div>
