<div xmlns:th="http://www.thymeleaf.org">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        .custom-dropdown {
            width: 200px;
        }
    </style>
    <section class="jumbotron text-center">
        <div class="container">
            <h1 class="jumbotron-heading">CULTURE COMPASS</h1>
            <h3 class="jumbotron-heading">All nodes</h3>
        </div>
    </section>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<<<<<<< HEAD
<<<<<<< HEAD
    <div>
        <form method="GET" action="/node/filteredByCategory">
            <label for="dropdown">Choose a category:</label>
            <select class="form-control form-control-sm custom-dropdown" name="category" id="dropdown">
                <option th:each="category : ${categories}">
                    <th:block th:value="${category}" th:text="${category}"></th:block>
                </option>
            </select>
            <input type="submit">
        </form>
    </div>
=======
=======
>>>>>>> 303725df8c4c41ced12c4410164a0c9a48751966
  <div class="row" style="margin: 0;"> 
    <div class="col-4" style="padding: 0;">
      <div id="additional-info"></div>
    </div>

    <div class="col-8" style="padding: 0;">
      <div id="map" style="height: 600px"></div>
    </div>
  </div>
    
<div>
    <form method="GET" action="/node/filteredByCategory">
        <label for="dropdown">Choose a category:</label>
        <select class="form-control form-control-sm custom-dropdown" name="category" id="dropdown">
            <option th:each="category : ${categories}">
                <th:block th:value="${category}" th:text="${category}"></th:block>
            </option>
        </select>
        <input type="submit">
    </form>
</div>
  
  <script th:inline="javascript">
    let nodes = [(${nodes})];
    let map = L.map("map")
        .setView([41.6086, 21.7453], 9); // Skopje
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ''
    }).addTo(map);
<<<<<<< HEAD
>>>>>>> 9f660dd9e2fc316db4437536d3f07f5bf4a4e260
=======
>>>>>>> 303725df8c4c41ced12c4410164a0c9a48751966

    let markers = [];


    nodes.forEach(function (node) {
        let marker = L.marker([node.latitude, node.longitude])  

<<<<<<< HEAD
<<<<<<< HEAD
    <script th:inline="javascript">
        let nodes = [(${nodes})];
        let map = L.map("map")
            .setView([41.6086, 21.7453], 8); // Macedonia
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        }).addTo(map);

        let markers = [];

        nodes.forEach(function (node) {
            let marker = L.marker([node.latitude, node.longitude])
                .bindPopup(node.name + '<br>Category: ' + node.category + '<br>' + node.wikipediaData + '<br>'
                    + '<button onclick="editNode(' + node.id + ')">Edit</button>'
                    + '<button onclick="getLocation(' + node.latitude + ',' + node.longitude + ')">Navigate</button>'
                );
            markers.push(marker);
=======
        marker.on('click', function (e) {
            displayInfo(node);
            changeColorAndFocus(marker, markers);
>>>>>>> 9f660dd9e2fc316db4437536d3f07f5bf4a4e260
=======
        marker.on('click', function (e) {
            displayInfo(node);
            changeColorAndFocus(marker, markers);
>>>>>>> 303725df8c4c41ced12c4410164a0c9a48751966
        });

        markers.push(marker);

    });

    let markerGroup = L.featureGroup(markers).addTo(map);

//         let markers = [];

//         nodes.forEach(function (node) {
//             let marker = L.marker([node.latitude, node.longitude])
//                 .bindPopup(node.name + '<br>Category: ' + node.category + '<br>' + node.wikipediaData + '<br>'
//                     + '<button onclick="editNode(' + node.id + ')">Edit</button>'
//                     + '<button onclick="getLocation(' + node.latitude + ',' + node.longitude + ')">Navigate</button>'
//                 );
//             markers.push(marker);
//         });

    map.fitBounds(markerGroup.getBounds());

    function editNode(nodeId) {
        window.location.href = '/node/edit-form/' + nodeId;
    }

    const displayInfo = (node) => {
        $("#additional-info").empty();  // Clear previous node data

        let mainDiv = $("#additional-info")

        let res = document.createElement("div");
        let paragraph = document.createElement("h3")
        let locations = document.createElement("p")
        let resetMap = document.createElement("button");
        let editButton = document.createElement("button");
        let navigateButton = document.createElement("button");
     
        resetMap.setAttribute("onclick", "resetMap()");
        resetMap.textContent = "Reset Map";

        editButton.setAttribute("onclick", `editNode(${node.id})`);
        editButton.textContent = "Edit";

        navigateButton.setAttribute("onclick", "getLocation()");
        navigateButton.textContent = "GPS";

        let node_explanation = []
        node_explanation.push("Information about: ");
        node_explanation.push(node.name);
        console.log(node.wikipediaData);
        if(node.wikipediaData) {
          node_explanation.push("Additional wiki data: ", node.wikipediaData);
        }

<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 303725df8c4c41ced12c4410164a0c9a48751966
        let userLatitude;
        let userLongitude;

        // Getting location
        const getLocation = (nodeLatitude, nodeLongitude) => {
            // Get the location from the user
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    userLatitude = position.coords.latitude;
                    userLongitude = position.coords.longitude;

                    console.log(userLatitude, userLongitude); // For kind of debugging purposes

                    sendLocationToServer(userLatitude, userLongitude, nodeLatitude, nodeLongitude);
                }, function () {
                    alert("Geolocation access is blocked. Please update your browser settings to allow access.")
                });
            } else {
                alert("Geolocation is not supported by this browser.")
            }
        };

        function sendLocationToServer(userLatitude, userLongitude, nodeLatitude, nodeLongitude) {
            console.log("Before fetch");
            fetch('/map/findRoute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', },
                body: `startLat=${userLatitude}&startLon=${userLongitude}&endLat=${nodeLatitude}&endLon=${nodeLongitude}`,
            }).then(response => {
                console.log("Received response with status: " + response.status); // For kind of debugging purposes

                if (response.status === 200) {
                    console.log("Location sent successfully!");
                    window.location.href = '/map';
                } else {
                    alert("Error getting location");
                }
            }).catch(error => {
                console.error("Error sending location:", error);
            });
        }
<<<<<<< HEAD
    </script>

    <div class="col mb-3">
        <div class="row">
            <div class="col-sm-5 col-md-6">
                <a href="/node/add-form" class="btn btn-block btn-dark add-product-btn">
                    Add new node
                </a>
            </div>
        </div>
    </div>
=======
=======
      
>>>>>>> 303725df8c4c41ced12c4410164a0c9a48751966
        paragraph.textContent = node_explanation.join("");
        locations.textContent = `${node.latitude}, ${node.longitude}`;

        res.setAttribute("class", "container");
        res.appendChild(paragraph);
        res.appendChild(locations);
        res.appendChild(resetMap);
        res.appendChild(editButton);
        res.appendChild(navigateButton);

        mainDiv.append(res);
    }

    const changeColorAndFocus = (marker, markers) => {
      markers.forEach((m) => {
        m.setIcon(new L.Icon.Default());
      });

      marker.setIcon(new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                tooltipAnchor: [16, -28],
                shadowSize: [41, 41]
            }))

      map.setView(marker.getLatLng(), 16);
    }

<<<<<<< HEAD
    const getLocation = () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                console.log(latitude, longitude);

                sendLocationToServer(latitude, longitude);
            }, function () {
                alert("Geolocation access is blocked. Please update your browser settings to allow access.")
            });
        } else {
            alert("Geolocation is not supported by this browser.")
        }
    };

    const resetMap = () => {
      map.setView([41.6086, 21.7453], 9);
    }
    function sendLocationToServer(latitude, longitude) {
          let endLat = 41.9983057;
          let endLon = 21.4254968;

          console.log("Before fetch")
          fetch('/map/findRoute', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `startLat=${latitude}&startLon=${longitude}&endLat=${endLat}&endLon=${endLon}`,
          }).then(response => {

            console.log("Received response with status: " + response.status);
            console.log(response.status);
            console.log(response.headers.get("Location"));

            if (response.status === 302) {
              // Handle redirect manually
              console.log("Redirecting to: " + response.headers.get("Location"));

            console.log("Before redirection");
            window.location.replace = response.headers.get("Location");
            console.log("After redirection");
            } else if (response.status === 200) {
                console.log("Location sent successfully!");
            }
          }).catch(error => {
            console.error("Error sending location:", error);
          });
        }
=======
    const resetMap = () => {
      map.setView([41.6086, 21.7453], 9);
    }
>>>>>>> 303725df8c4c41ced12c4410164a0c9a48751966
    </script>

<div class="col mb-3">
    <div class="col-sm-2 col-md-2">
      <a href="/node/add-form" class="btn btn-block btn-dark add-product-btn">
        Add new node
      </a>
    </div>
</div>
</div>
</div>
<<<<<<< HEAD
>>>>>>> 9f660dd9e2fc316db4437536d3f07f5bf4a4e260
=======
>>>>>>> 303725df8c4c41ced12c4410164a0c9a48751966
</div>
