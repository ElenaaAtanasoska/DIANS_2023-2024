<div xmlns:th="http://www.thymeleaf.org">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        .custom-dropdown {
            width: 200px;
        }
    </style>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <section class="jumbotron text-center">
        <div class="container">
            <h1 class="jumbotron-heading">CULTURE COMPASS</h1>
            <h3 class="jumbotron-heading">All nodes</h3>
        </div>
    </section>

    <div>
        <form method="GET" action="/node/filteredByCategory">
            <label for="dropdown">Choose a category:</label>
            <select class="form-control form-control-sm custom-dropdown" name="category" id="dropdown">
                <option th:each="category : ${categories}">
                    <th:block th:value="${category}" th:text="${category}"></th:block>
                </option>
            </select>
            <input type="submit">
        </form>
    </div>

    <div id="map" th:style="'height: 500px; width: 500px; margin: 0 auto;'"></div>


    <script th:inline="javascript">
        let nodes = [(${nodes})];
        let map = L.map("map")
            .setView([41.6086, 21.7453], 8); // Macedonia
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        }).addTo(map);

        let markers = [];

        nodes.forEach(function (node) {
            let marker = L.marker([node.latitude, node.longitude])
                .bindPopup(node.name + '<br>Category: ' + node.category + '<br>' + node.wikipediaData + '<br>'
                    + '<button onclick="editNode(' + node.id + ')">Edit</button>'
                    + '<button onclick="getLocation(' + node.latitude + ',' + node.longitude + ')">Navigate</button>'
                );
            markers.push(marker);
        });

        let markerGroup = L.featureGroup(markers).addTo(map);

        map.fitBounds(markerGroup.getBounds());

        function editNode(nodeId) {
          window.location.href = '/node/edit-form/' + nodeId;
        }

        let userLatitude;
        let userLongitude;

        // Getting location
        const getLocation = (nodeLatitude, nodeLongitude) => {
            // Get the location from the user
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    userLatitude = position.coords.latitude;
                    userLongitude = position.coords.longitude;

                    console.log(userLatitude, userLongitude); // For kind of debugging purposes

                    sendLocationToServer(userLatitude, userLongitude, nodeLatitude, nodeLongitude);
                }, function () {
                    alert("Geolocation access is blocked. Please update your browser settings to allow access.")
                });
            } else {
                alert("Geolocation is not supported by this browser.")
            }
        };

        function sendLocationToServer(userLatitude, userLongitude, nodeLatitude, nodeLongitude) {
            console.log("Before fetch");
            fetch('/map/findRoute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded', },
                body: `startLat=${userLatitude}&startLon=${userLongitude}&endLat=${nodeLatitude}&endLon=${nodeLongitude}`,
            }).then(response => {
                console.log("Received response with status: " + response.status); // For kind of debugging purposes

                if (response.status === 200) {
                    console.log("Location sent successfully!");
                    window.location.href = '/map';
                } else {
                    alert("Error getting location");
                }
            }).catch(error => {
                console.error("Error sending location:", error);
            });
        }
    </script>

    <div class="col mb-3">
        <div class="row">
            <div class="col-sm-5 col-md-6">
                <a href="/node/add-form" class="btn btn-block btn-dark add-product-btn">
                    Add new node
                </a>
            </div>
        </div>
    </div>
</div>
